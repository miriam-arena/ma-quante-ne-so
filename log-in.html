<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma quante ne so?</title>
    <link rel="stylesheet" href="style/bootstrap.css">
    <link rel="stylesheet" href="style/custom.css">
    <script src="js/lib.js"></script>
</head>
<body>
    <div class="container d-flex flex-column text-center justify-content-center min-vh-100">
        <div class="row">
            <div class="col-12">
                <h2 class="text-primary">FAI IL LOGIN!</h2>
            </div>
          </div>
          <div class="row">
            <div class="col-1 col-md-4"></div>
            <div class="col-10 col-md-4">
                <form id="loginForm">
                  <div class="form-group">
                    <label for="email-login">Email</label>
                    <input type="email" class="form-control form-control-sm border-secondary" id="email-login" aria-describedby="emailHelp" name="email_login">
                  </div>
                  <div class="form-group">
                    <label for="password-login">Password</label>
                    <input type="password" class="form-control form-control-sm border-secondary" id="password-login" name="password_login">
                  </div>
                </form>
            </div>
            <div class="col-1 col-md-4"></div>
        </div>
        <div class="row mb-5">
            <div class="col-12">
              <button type="button" class="btn btn-secondary" id="loginUserBtn">
                  Invia
              </button>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <h2 class="text-primary">O REGISTRATI PER INIZIARE!</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-1 col-md-4"></div>
            <div class="col-10 col-md-4">
                <form id="regForm">
                    <div class="form-group dropdown">
                        <label for="exampleFormControlSelect1"></label>
                        <button id="options_button" class="btn btn-outline-primary dropdown-toggle" type="button" data-toggle="dropdown">
                            <span id="avatar-span">Scegli il tuo avatar</span>
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li class="text-secondary dropdown-item"><img src="img/parmigiano.png" width="70" alt="icona_parmigiano">Parmigiano</li>
                            <li class="text-secondary dropdown-item"><img src="img/museo_icona.png" width="70" alt="icona_museo">Museo</li>
                            <li class="text-secondary dropdown-item"><img src="img/prosciutto.png" width="70" alt="icona_prosciutto">Prosciutto</li>
                        </ul>
                    </div>
                    <div class="form-group">
                      <label for="email-input">Email</label>
                      <input type="email" class="form-control form-control-sm border-secondary" id="email-input" aria-describedby="emailHelp" name="email">
                      <small id="emailHelp" class="form-text text-muted">Non condivideremo mai la tua mail con nessun altro.</small>
                    </div>
                    <div class="form-group">
                      <label for="password-input">Password</label>
                      <input type="password" class="form-control form-control-sm border-secondary" id="password-input" name="password">
                    </div>
                    <div class="form-group">
                      <label for="password-input2">Conferma Password</label>
                      <input type="password" class="form-control form-control-sm border-secondary" id="password-input2" name="confirm_password">
                    </div>
                    <div class="form-group">
                        <label for="options-input">Associazione</label>
                        <select class="form-control form-control-sm border-secondary" id="options-input"  name="associations">
                        <option value="1" id="option">Associazione 1</option>
                        <option value="2">Associazione 2</option>
                        <option value="3">Associazione 3</option>
                        <option value="4">Associazione 4</option>
                        <option value="5">Associazione 5</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-secondary" id="registerUserBtn">
                        Invia
                    </button>
                    <div class="modal fade" id="startQuizModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                                <h2 id="qModalTitle">Registrazione effettuata</h2>
                            </div>
                            <div class="modal-body">
                              <p>Ricordati di scaricare l'app di Quick Museum prima di proseguire!</p>
                                <a href="https://www.quickmuseum.it/">
                                    <img class="d-flex m-auto" src="img/quick-museum-logo.png" alt="quickmuseum">
                                </a>
                                <a href="https://apps.apple.com/it/app/quickmuseum/id1173475571">
                                    <img src="https://www.quickmuseum.it/wp-content/uploads/2019/06/Apple_Store.png" alt="icona-apple" width="100">
                                </a>
                                <a href="https://play.google.com/store/apps/details?id=com.arternative.quickmuseum">
                                    <img src="https://www.quickmuseum.it/wp-content/uploads/2019/06/Play_Store.png" alt="icona-play-store" width="100">
                                </a>
                            </div>
                            <div class="modal-footer justify-content-center">
                              <a href="log-in.html"><button type="button" class="btn btn-secondary" >Prosegui se hai gi√† provveduto :)</button></a>
                            </div>
                          </div>
                        </div>
                      </div>
                </form>
            </div>
            <div class="col-1 col-md-4"></div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>

    <script>
        $(document).ready(function()
        {
          // check logged in user
          $.post( "https://artathlon.arternative-lab.eu/api/quizVisitorLogged", { c : getCookie('loginToken'), su : 2}, function( data )
          {
            const nextLocation = evaluateUser(data)
            if (nextLocation.forward && nextLocation.location != "log-in.html")
               window.location = nextLocation.location;
          });

            $('.dropdown-item').click(function()
            {
                var img = $('<img />', {
                                src: $(this).find('img').attr('src'),
                                width: '120',
                                alt: 'avatar'
                            });
                $('#avatar-span').html(img);
            })

            $('#startQuizModal').on('hidden.bs.modal', function ()
            {
               window.location = "log-in.html";
            })
        });

        $("#registerUserBtn").click(function()
        {
           $('.errors').remove();
          // populate the title tag
          $.post( "https://artathlon.arternative-lab.eu/api/registerQuizVisitor", $("#regForm").serialize(), function( data )
          {
             data = JSON.parse(data);
             if (data.error_e)
                $("input[name='email']").after("<p style='color:red' class='errors'>"+data.error_e+"</p>");
             else if (data.error_e2)
                $("input[name='email']").after("<p style='color:red' class='errors'>"+data.error_e2+"</p>");
             if (data.error_p)
               $("input[name='password']").after("<p style='color:red' class='errors'>"+data.error_p+"</p>");
             else if (data.error_p2)
                $("input[name='confirm_password']").after("<p style='color:red' class='errors'>"+data.error_p2+"</p>");
             else if (data.error_p3)
                $("input[name='confirm_password']").after("<p style='color:red' class='errors'>"+data.error_p3+"</p>");

            if (data.code == 200) // can continue
            {
              // store login acces in cookie
              let today = new Date();
              var expire = new Date();
              expire.setTime(today.getTime() + 3600000*24*35);
              document.cookie = "loginToken="+data.token+"; SameSite=None; Secure; path=/" + "; expires="+expire.toUTCString();

              $('#qModalTitle').html("Login corretto");
              $('#startQuizModal').modal('show');
            }
          });
        });

        $("#loginUserBtn").click(function()
        {
           $('.errors-l').remove();
          // populate the title tag
          $.post( "https://artathlon.arternative-lab.eu/api/loginQuizVisitor", $("#loginForm").serialize(), function( data )
          {
            data = JSON.parse(data);
            if (data.error_el)
               $("input[name='email_login']").after("<p style='color:red' class='errors-l'>"+data.error_el+"</p>");
            if (data.error_pl)
              $("input[name='password_login']").after("<p style='color:red' class='errors-l'>"+data.error_pl+"</p>");
            if (data.error_l)
              $("#loginUserBtn").after("<p style='color:red' class='errors-l'>"+data.error_l+"</p>");


            if (data.code == 200) // can continue
            {
              // store login acces in cookie
              let today = new Date();
              var expire = new Date();
              expire.setTime(today.getTime() + 3600000*24*35);
              document.cookie = "loginToken="+data.token+"; SameSite=None; Secure; path=/" + "; expires="+expire.toUTCString();

              $('#startQuizModal').modal('show');
            }

          });
        });

    </script>

</body>
</html>
