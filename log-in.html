<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma quante ne so?</title>
    <link rel="stylesheet" href="style/bootstrap.css">
    <link rel="stylesheet" href="style/custom.css">
    <script src="js/lib.js"></script>
    <style>
      body {
          background-image: url("img/ma-quante-ne-so-logo-trans3.png");
          background-position: center;
          background-repeat: no-repeat;
          background-size: contain;
      }
      input[type=radio] {display: block;}
      #private-signup, #class-signup{display: none;}
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
          <div class="col-12 col-md-6">
            <form id="loginForm" class="mb-5">
              <h2 class="text-primary">FAI IL LOGIN!</h2>
              <div class="form-group">
                <label for="email-login">Email</label>
                <input type="email" class="form-control form-control-sm border-secondary" id="email-login" aria-describedby="emailHelp" name="email_login">
              </div>
              <div class="form-group">
                <label for="password-login">Password</label>
                <input type="password" class="form-control form-control-sm border-secondary" id="password-login" name="password_login">
                <small class="form-text text-muted"><a href="#" class="text-secondary" type="submit" data-toggle="modal" data-target="#recuperoPassword">Clicca qui se hai dimenticato la password.</a></small>
              </div>
              <button type="button" class="btn btn-secondary mb-5 col-12" id="loginUserBtn">
                Via!
            </button>
            </form>
      </div>
      <div class="modal fade" id="recuperoPassword" tabindex="-1" aria-labelledby="recuperoPasswordLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Per recuperare la password manda un'email a: info@arternative.it
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
          <div class="col-12 col-md-6">
              <form id="regForm" class="mb-5">
                <h2 class="text-primary">O REGISTRATI PER INIZIARE!</h2>
                  <div class="form-group dropdown text-center">
                      <button id="options_button" class="btn btn-outline-primary dropdown-toggle" type="button" data-toggle="dropdown">
                          <span id="avatar-span">Scegli l'avatar</span>
                          <span class="caret"></span>
                      </button>
                      <ul class="dropdown-menu">
                          <li class="text-secondary dropdown-item"><img src="img/parmigiano.png" width="50" alt="icona_parmigiano">  Parmigiano</li>
                          <li class="text-secondary dropdown-item"><img src="img/museo.png" width="50" alt="icona_museo">  Museo</li>
                          <li class="text-secondary dropdown-item"><img src="img/prosciutto.png" width="50" alt="icona_prosciutto">  Prosciutto</li>
                          <li class="text-secondary dropdown-item"><img src="img/fiasco.png" width="50" alt="icona_fiasco">  Fiasco</li>
                          <li class="text-secondary dropdown-item"><img src="img/utensili.png" width="50" alt="icona_utensili">  Utensili</li>
                          <li class="text-secondary dropdown-item"><img src="img/gatto.png" width="50" alt="icona_gatto">  Gatto</li>
                      </ul>
                      <input type="hidden" name="avatar" value="img/parmigiano.png" id="avatar-input">
                  </div>
                  <div class="form-group">
                    <label for="nic-input">Nickname</label>
                    <input type="text" class="form-control form-control-sm border-secondary" id="nic-input" name="nic" required>
                  </div>
                  <div class="form-group">
                    <label for="email-input">Email*</label>
                    <input type="email" class="form-control form-control-sm border-secondary" id="email-input" aria-describedby="emailHelp" name="email" required>
                    <small id="emailHelp" class="form-text text-muted">Non condivideremo mai la tua mail con nessun altro.</small>
                  </div>
                  <div class="form-group">
                    <label for="password-input">Password*</label>
                    <input type="password" class="form-control form-control-sm border-secondary" id="password-input" name="password" required>
                  </div>
                  <div class="form-group">
                    <label for="password-input2">Conferma Password*</label>
                    <input type="password" class="form-control form-control-sm border-secondary" id="password-input2" name="confirm_password" required>
                  </div>

                    <div class="row mb-2">
                      <div class="col-12">
                        Tipo iscrizione:
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-1 pt-2">
                        <input type="radio" value="2" id="qq1" name="signup_type" >
                      </div>
                      <div class="col-10">
                        <label for="qq1">Vuoi giocare come persona singola o gruppo informale</span>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-1 pt-2">
                        <input type="radio" value="1" id="qq2" name="signup_type" >
                      </div>
                      <div class="col-10">
                        <label for="qq2">Vuoi giocare come classe di scuola</label>
                      </div>
                    </div>

                  <!-- Class sign-up -->
                  <div id="class-signup">
                    <div class="form-group">
                      <label for="school-input">Nome scuola</label>
                      <input type="text" class="form-control form-control-sm border-secondary" id="school-input" name="school" required>
                    </div>
                    <div class="form-group">
                      <label for="cit-input1">Citt&agrave;</label>
                      <input type="text" class="form-control form-control-sm border-secondary" id="cit-input1" name="cit" required>
                    </div>
                    <div class="form-group">
                      <label for="avg-age">Et&agrave; media</label>
                      <input type="text" class="form-control form-control-sm border-secondary" id="avg-age" name="age" required>
                    </div>
                    <div class="form-group">
                        <label for="ass-select1">Vuoi affiliarti a un'associazione di Emiliano Romagnoli all'estero?</label>
                        <select class="form-control form-control-sm border-secondary" id="ass-select1"  name="associations" aria-describedby="assHelp">
                          <option value="0"></option>
                        </select>
                        <small id="assHelp1" class="form-text text-muted">
                          se non trovi la tua associazione di riferimenti è perché non si è iscritta al gioco.
                        </small>
                    </div>
                  </div>

                  <!-- private user sign-up -->
                  <div id="private-signup">
                    <div class="form-group">
                      <label for="naz-input">Nazionalit&agrave;</label>
                      <input type="text" class="form-control form-control-sm border-secondary" id="naz-input" name="nat" required>
                    </div>
                    <div class="form-group">
                      <label for="cit-input">Da che citt&agrave; giochi</label>
                      <input type="text" class="form-control form-control-sm border-secondary" id="cit-input" name="cit" required>
                    </div>
                    <div class="form-group">
                      <label for="region">Da quale regione italiana vieni</label>
                      <input type="text" class="form-control form-control-sm border-secondary" id="region" name="region" required>
                    </div>
                    <div class="form-group">
                        <label for="ass-select">Vuoi affiliarti a un'associazione di Emiliano Romagnoli all'estero?</label>
                        <select class="form-control form-control-sm border-secondary" id="ass-select"  name="associations" aria-describedby="assHelp">
                          <option value="0"></option>
                        </select>
                        <small id="assHelp" class="form-text text-muted">
                          se non trovi la tua associazione di riferimenti è perché non si è iscritta al gioco.
                        </small>
                    </div>
                  </div>

                  <button type="button" class="btn btn-secondary mb-5 col-12" id="registerUserBtn" disabled>
                      Registrati e comincia!
                  </button>
              </form>
          </div>
          <div class="col-1"></div>



      <!-- modal -->
      <div class="modal fade" id="startQuizModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                  <h2 id="qModalTitle">Registrazione effettuata</h2>
              </div>
              <div class="modal-body">
                <p>Ricordati di scaricare l'app di Quick Museum prima di proseguire!</p>
                  <a href="https://www.quickmuseum.it/">
                      <img class="d-flex m-auto" src="img/quick-museum-logo.png" alt="quickmuseum">
                  </a>
                  <a href="https://apps.apple.com/it/app/quickmuseum/id1173475571">
                      <img src="https://www.quickmuseum.it/wp-content/uploads/2019/06/Apple_Store.png" alt="icona-apple" width="100">
                  </a>
                  <a href="https://play.google.com/store/apps/details?id=com.arternative.quickmuseum">
                      <img src="https://www.quickmuseum.it/wp-content/uploads/2019/06/Play_Store.png" alt="icona-play-store" width="100">
                  </a>
              </div>
              <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" id="modalButton">Prosegui se hai già provveduto :)</button>
              </div>
            </div>
          </div>
        </div>

    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>

    <script>
        $(document).ready(function()
        {
          // populate the options of the Associtions select
          $.get("https://artathlon.arternative-lab.eu/api/getPartner", function(data)
          {
            for (var ass of data)
            {
                $("<option />",{'value': ass.id, 'html': ass.name}).appendTo("#ass-select");
            }
          });

          // check logged in user
          $.post( "https://artathlon.arternative-lab.eu/api/quizVisitorLogged", { c : getCookie('loginToken'), su : 2}, function( data )
          {
            const nextLocation = evaluateUser(data)
            if (nextLocation.forward && nextLocation.location != "log-in.html")
               window.location = nextLocation.location;
          });

            $('.dropdown-item').click(function()
            {
                var img = $('<img />', {
                                src: $(this).find('img').attr('src'),
                                width: '70',
                                alt: 'avatar'
                            });
                $('#avatar-span').html(img);
                $('#avatar-input').attr('value', $(this).find('img').attr('src'));
            })
            $('#modalButton').click(function()
            {
                $('#startQuizModal').modal('hide');
            })
            $('#startQuizModal').on('hidden.bs.modal', function ()
            {
               window.location = "log-in.html";
            })
        });

        $("#registerUserBtn").click(function()
        {
           $('.errors').remove();
          // populate the title tag
          $.post( "https://artathlon.arternative-lab.eu/api/registerQuizVisitor", $("#regForm").serialize(), function( data )
          {
             data = JSON.parse(data);
             if (data.error_e)
                $("input[name='email']").after("<p style='color:red' class='errors'>"+data.error_e+"</p>");
             else if (data.error_e2)
                $("input[name='email']").after("<p style='color:red' class='errors'>"+data.error_e2+"</p>");
             if (data.error_p)
               $("input[name='password']").after("<p style='color:red' class='errors'>"+data.error_p+"</p>");
             else if (data.error_p2)
                $("input[name='confirm_password']").after("<p style='color:red' class='errors'>"+data.error_p2+"</p>");
             else if (data.error_p3)
                $("input[name='confirm_password']").after("<p style='color:red' class='errors'>"+data.error_p3+"</p>");

            if (data.code == 200) // can continue
            {
              // store login acces in cookie
              let today = new Date();
              var expire = new Date();
              expire.setTime(today.getTime() + 3600000*24*35);
              document.cookie = "loginToken="+data.token+"; SameSite=None; Secure; path=/" + "; expires="+expire.toUTCString();

              $('#qModalTitle').html("Login corretto");
              $('#startQuizModal').modal('show');
            }
          });
        });

        $("#loginUserBtn").click(function()
        {
           $('.errors-l').remove();
          // populate the title tag
          $.post( "https://artathlon.arternative-lab.eu/api/loginQuizVisitor", $("#loginForm").serialize(), function( data )
          {
            data = JSON.parse(data);
            if (data.error_el)
               $("input[name='email_login']").after("<p style='color:red' class='errors-l'>"+data.error_el+"</p>");
            if (data.error_pl)
              $("input[name='password_login']").after("<p style='color:red' class='errors-l'>"+data.error_pl+"</p>");
            if (data.error_l)
              $("#loginUserBtn").after("<p style='color:red' class='errors-l'>"+data.error_l+"</p>");


            if (data.code == 200) // can continue
            {
              // store login acces in cookie
              let today = new Date();
              var expire = new Date();
              expire.setTime(today.getTime() + 3600000*24*35);
              document.cookie = "loginToken="+data.token+"; SameSite=None; Secure; path=/" + "; expires="+expire.toUTCString();

              $('#startQuizModal').modal('show');
            }

          });
        });

        $("input[type=radio]").change(function()
        {
          $("#registerUserBtn").removeAttr("disabled")
          if ($(this).val() == 1)
          {
            $("#class-signup").show();
            $("#private-signup").hide();
          }
          else
          {
            $("#class-signup").hide();
            $("#private-signup").show();
          }
        });

    </script>

</body>
</html>
