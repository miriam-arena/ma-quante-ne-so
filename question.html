<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ma quante ne so?</title>
    <link rel="stylesheet" href="style/bootstrap.css">
    <link rel="stylesheet" href="style/custom.css">
    <script src="js/lib.js"></script>
</head>
<body class="h-auto">
    <div id="container-timeline" class="container justify-content-between align-items-center text-center mt-5">
      <div class="row">
        <div class="col-1 col-lg-2"></div>
        <div class="col-6 col-md-8">
          <div id="timeline"></div>
          <div id="progressTimeline"></div>
          <div class="tooltip-click">
            <a href="#">
              <div id="start" class="puntatore mfirst timeline-icon one">
                <img width="40" src="img/start.png" alt="icona-start">
              </div>
            </a>
            <strong id="tooltip-pointer-start" class="tooltip-pointer">
              <p> Via</p>
              <span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
              </svg></span>
            </strong>
          </div>
          <div class="tooltip-click">
            <a href="#">
              <div id="avatar" class="puntatore mfirst timeline-icon one">
                <img height="35" src="" alt="">
              </div>
            </a>
            <strong id="tooltip-pointer-avatar" class="tooltip-pointer">
              <p> Avatar</p>
              <span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
              </svg></span>
            </strong>
          </div>
          <div class="tooltip-click">
            <a href="#">
              <div id="pointer1" class="puntatore m2 timeline-icon two">
                <img id="pointer1_img" height="35" src="img/pointer1.png" alt="pointer1">
              </div>
            </a>
            <strong id="tooltip-pointer-language" class="tooltip-pointer">
              <p> Fine <br> La lingua italiana</p>
              <span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
              </svg></span>
            </strong>
          </div>
          <div class="tooltip-click">
            <a href="#">
              <div id="pointer2" class="puntatore m3 timeline-icon three">
                <img id="pointer2_img" height="35" src="img/pointer2.png" alt="pointer2">
              </div>
            </a>
            <strong id="tooltip-pointer-museum" class="tooltip-pointer">
              <p> Fine <br> Il Museo Brozzi</p>
              <span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
              </svg></span>
            </strong>
          </div>
          <div class="tooltip-click">
            <a href="#">
              <div id="pointer3" class="puntatore mlast timeline-icon four">
                <img id="pointer3_img" height="35" src="img/pointer3.png" alt="pointer3">
              </div>
            </a>
            <strong id="tooltip-pointer-territory" class="tooltip-pointer">
              <p> Fine <br>Il territorio</p>
              <span><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-x" viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
              </svg></span>
            </strong>
          </div>
        </div>
        <div class="col-5 col-md-3 col-lg-2 text-right">
          <button type="button" class="btn btn-primary text-light" href="#" id="logoutUserBtn">Log out</button>
      </div>
    </div>
  </div>

  <div class="container d-flex flex-column justify-content-center align-items-center mt-5">

    <!-- LONG TEXT -->
      <div class="row">
        <div class="d-none d-lg-block col-lg-2"></div> <!-- empty line just to fill some space -->
        <div class="col-12 col-lg-8" id="long_text"></div>
        <div class="d-none d-lg-block col-lg-2"></div> <!-- empty line just to fill some space -->
      </div>


      <!-- QUESTION VIDEO -->
      <div class="row mb-4">
          <div class="col-12 text-center" id="questionVideo">
          </div>
      </div>


      <!-- QUESTION -->
      <div class="row">
          <div class="col-12 text-center">
              <h2 id="question"></h2>
          </div>
      </div>


      <!-- QUESTION IMAGE -->
      <div class="row">
          <div class="col-12 text-center">
              <img id="questionImg" alt="" src="" style="max-width:800px; padding-top:20px; width:100%;">
          </div>
      </div>


      <!-- REPLIES -->
      <div class="row mt-1 mt-md-5 mb-5">
        <div class="col-12 text-left">
          <div class="form-check" id="check1">
            <label>
              <input class="form-check-input" type="radio" name="answer" id="answer1" value="1"/>
              <div class="circle">
                <div class="circle--inner circle--inner__1" ></div>
                <div class="circle--inner circle--inner__2" ></div>
                <div class="circle--inner circle--inner__3" ></div>
                <div class="circle--inner circle--inner__4" ></div>
                <div class="circle--inner circle--inner__5" ></div>
                <div class="circle--outer" ></div>
              </div>
              <svg width="30" height="30">
                <defs>
                  <filter id="gooey">
                    <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="3"/>
                    <feColorMatrix
                      in="blur"
                      mode="matrix"
                      values="
                        1 0 0 0 0
                        0 1 0 0 0
                        0 0 1 0 0
                        0 0 0 18 -7"
                      result="gooey"
                    />
                    <feBlend in2="gooey" in="SourceGraphic" result="mix"/>
                  </filter>
                </defs>
              </svg>
            </label>
            <label class="form-check-label" style="max-width:90%;" for="answer1">
                <h3></h3>
            </label>
          </div>


          <div class="form-check" id="check2">
            <label>
              <input class="form-check-input" type="radio" name="answer" id="answer2" value="2"/>
              <div class="circle">
                <div class="circle--inner circle--inner__1" ></div>
                <div class="circle--inner circle--inner__2" ></div>
                <div class="circle--inner circle--inner__3" ></div>
                <div class="circle--inner circle--inner__4" ></div>
                <div class="circle--inner circle--inner__5" ></div>
                <div class="circle--outer" ></div>
              </div>
              <svg width="30" height="30">
                <defs>
                  <filter id="gooey">
                    <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="3"/>
                    <feColorMatrix
                      in="blur"
                      mode="matrix"
                      values="
                        1 0 0 0 0
                        0 1 0 0 0
                        0 0 1 0 0
                        0 0 0 18 -7"
                      result="gooey"
                    />
                    <feBlend in2="gooey" in="SourceGraphic" result="mix"/>
                  </filter>
                </defs>
              </svg>
            </label>
            <label class="form-check-label" style="max-width:90%;" for="answer2">
                <h3></h3>
            </label>
          </div>


          <div class="form-check" id="check3">
            <label>
              <input class="form-check-input" type="radio" name="answer" id="answer3"  value="3"/>
              <div class="circle">
                <div class="circle--inner circle--inner__1" ></div>
                <div class="circle--inner circle--inner__2" ></div>
                <div class="circle--inner circle--inner__3" ></div>
                <div class="circle--inner circle--inner__4" ></div>
                <div class="circle--inner circle--inner__5" ></div>
                <div class="circle--outer" ></div>
              </div>
              <svg width="30" height="30">
                <defs>
                  <filter id="gooey">
                    <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="3"/>
                    <feColorMatrix
                      in="blur"
                      mode="matrix"
                      values="
                        1 0 0 0 0
                        0 1 0 0 0
                        0 0 1 0 0
                        0 0 0 18 -7"
                      result="gooey"
                    />
                    <feBlend in2="gooey" in="SourceGraphic" result="mix"/>
                  </filter>
                </defs>
              </svg>
            </label>
            <label class="form-check-label" style="max-width:90%;" for="answer3">
                <h3></h3>
            </label>
          </div>


          <div class="form-check" id="check4">
            <label>
              <input class="form-check-input" type="radio" name="answer" id="answer4" value="4"/>
              <div class="circle">
                <div class="circle--inner circle--inner__1" ></div>
                <div class="circle--inner circle--inner__2" ></div>
                <div class="circle--inner circle--inner__3" ></div>
                <div class="circle--inner circle--inner__4" ></div>
                <div class="circle--inner circle--inner__5" ></div>
                <div class="circle--outer" ></div>
              </div>
              <svg width="30" height="30">
                <defs>
                  <filter id="gooey">
                    <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="3"/>
                    <feColorMatrix
                      in="blur"
                      mode="matrix"
                      values="
                        1 0 0 0 0
                        0 1 0 0 0
                        0 0 1 0 0
                        0 0 0 18 -7"
                      result="gooey"
                    />
                    <feBlend in2="gooey" in="SourceGraphic" result="mix"/>
                  </filter>
                </defs>
              </svg>
            </label>
            <label class="form-check-label" style="max-width:90%;" for="answer4">
                <h3></h3>
            </label>
          </div>


          <div class="form-check" id="check5">
            <label>
              <input class="form-check-input" type="radio" name="answer" id="answer5" value="5"/>
              <div class="circle">
                <div class="circle--inner circle--inner__1" ></div>
                <div class="circle--inner circle--inner__2" ></div>
                <div class="circle--inner circle--inner__3" ></div>
                <div class="circle--inner circle--inner__4" ></div>
                <div class="circle--inner circle--inner__5" ></div>
                <div class="circle--outer" ></div>
              </div>
              <svg width="30" height="30">
                <defs>
                  <filter id="gooey">
                    <feGaussianBlur in="SourceGraphic" result="blur" stdDeviation="3"/>
                    <feColorMatrix
                      in="blur"
                      mode="matrix"
                      values="
                        1 0 0 0 0
                        0 1 0 0 0
                        0 0 1 0 0
                        0 0 0 18 -7"
                      result="gooey"
                    />
                    <feBlend in2="gooey" in="SourceGraphic" result="mix"/>
                  </filter>
                </defs>
              </svg>
            </label>
            <label class="form-check-label" style="max-width:90%;" for="answer5">
                <h3></h3>
            </label>
          </div>
        </div>
      </div>
      <div class="row mt-3 mt-md-5 mb-5 text-center">
          <div class="col-6">
            <a href="#" id="previousLink" class="nextPrevBtn"><button class="btn btn-success btn-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-caret-left-fill" viewBox="0 0 16 16">
                    <path d="m3.86 8.753 5.482 4.796c.646.566 1.658.106 1.658-.753V3.204a1 1 0 0 0-1.659-.753l-5.48 4.796a1 1 0 0 0 0 1.506z"/>
                </svg>
            </button></a>
          </div>
          <div class="col-6">
              <a href="#" id="followingLink" class="nextPrevBtn"><button class="btn btn-success btn-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" class="bi bi-caret-right-fill" viewBox="0 0 16 16">
                      <path d="m12.14 8.753-5.482 4.796c-.646.566-1.658.106-1.658-.753V3.204a1 1 0 0 1 1.659-.753l5.48 4.796a1 1 0 0 1 0 1.506z"/>
                  </svg>
              </button></a>
          </div>
      </div>

  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
    <script>
     $(document).ready(function()
      {
          const allParams = new URLSearchParams(window.location.search);
          const s = allParams.get("s");
          const q = allParams.get("q");

          // check logged in user
          $.post( "https://artathlon.arternative-lab.eu/api/quizVisitorLogged",{c : getCookie('loginToken'), su : 2, q: q}, function( data )
          {
            const nextLocation = evaluateUser(data)
            if (nextLocation.forward && s != "1" && q != "1") // if the user is at the first question, do not redirect
               window.location = nextLocation.location;

            data = JSON.parse(data);
            // build the name of the negative avatar img
            const arr = data.avatar.split(".");
            var avatarImg = arr[0]+"-negativo."+arr[1];
           $("#avatar").find("img").attr("src", avatarImg);
          });

          // populate the question, long_text and replies tag
          $.get( "https://artathlon.arternative-lab.eu/api/quizQuestion/2/"+s+"/"+q, function( data )
          {
            $("#question").html(data.question);

            if (data.long_text != "")
              $("#long_text").html(data.long_text);

            if (data.image && data.image != "")
              $("#questionImg").attr("src", "https://artathlon.arternative-lab.eu/storage/"+data.image).attr("alt", "descrizione immagine assente");

            if (data.video && data.video != "[]")
            {
              let obj = JSON.parse(data.video);
              let htmlBlock = "Guarda il breve video e rispondi alla domanda<br><br>"
                            + "<video controls style='width:100%'>"
                            +   "<source src='https://artathlon.arternative-lab.eu/storage/"+obj[0].download_link+"' type='video/mp4'>"
                            + "</video>";
              $("#questionVideo").html(htmlBlock);
            }

            // show response options
            if (data.reply_1)
            {
              $("#check1>.form-check-label>h3").html(data.reply_1);
              $("#check1").show();
            }
            if (data.reply_2)
            {
              $("#check2>.form-check-label>h3").html(data.reply_2);
              $("#check2").show();
            }
            if (data.reply_3)
            {
              $("#check3>.form-check-label>h3").html(data.reply_3);
              $("#check3").show();
            }
            if (data.reply_4)
            {
              $("#check4>.form-check-label>h3").html(data.reply_4);
              $("#check4").show();
            }
            if (data.reply_5)
            {
              $("#check5>.form-check-label>h3").html(data.reply_5);
              $("#check5").show();
            }

              // $("#sections-titles").html(data[s-1].name).show(1000);
              // $("#questionLink").attr("href", "question.html?s="+s+"&q=1")
          });

          // populate the next/previous link attribute
          $.get( "https://artathlon.arternative-lab.eu/api/moreQuestionData/2/"+s+"/"+q, function( data )
          {
            data = JSON.parse(data);

            if (data.next > 0) // there is another question, show the "following question" link
              $("#followingLink").show().attr("href", "question.html?s="+data.section+"&q="+data.next)
            else
              $("#followingLink").hide();

            if (data.prev > 0 /*&& data.prevSection == data.section*/) // there is a previous question, show the "previous question" link
              $("#previousLink").show().attr("href", "question.html?s="+data.prevSsection+"&q="+data.prev)
            else
              $("#previousLink").hide();

            if (data.section == 0) // need to change section
              $("#followingLink").show().attr("href", "finish-line.html")
            else if (data.section != s) // need to change section
              $("#followingLink").show().attr("href", "section-end.html?s="+data.section+"&q="+data.next)

            // position of the user in the top bar
            const tqn = data.tqn + 3; // total number of questions in quiz...need to increase it a bit as the question seq number don't really match (ie. 23)
            const cq = q;           // current question number (ie. 12)
            const avatar = document.querySelector('#avatar');
            const progressTimeline = document.querySelector('#progressTimeline');
            const tooltip = document.querySelector('#tooltip-pointer-avatar');
            let progressPercent = (cq / tqn) * 100;

            avatar.style.setProperty('left', progressPercent + '%');
            tooltip.style.setProperty('left', progressPercent + '%');
            progressTimeline.setAttribute('style','width: ' + progressPercent + '%');

            // define the section number
            if (cq>15){ // 15 is the number of the last question of the second section
              section=3;
            }
            else if(cq>10){ // 10 is the number of the last question of the first section
              section=2;
            }
            else{
              section=5;
            }
            for(i=1;i<section;i++){ // change the colour of the pointers for the completed sections
              $('#pointer'+i+'_img').attr('src', 'img/pointer'+i+'_negativo.png');
              $('#pointer'+i).attr('style','background-color:#FE6D73 !important;');
            }

            const mq = window.matchMedia( "(max-width: 600px)" );
            const start = document.querySelector('#start');
            const pointer1 = document.querySelector('#pointer1');
            const pointer2 = document.querySelector('#pointer2');
            const pointer3 = document.querySelector('#pointer3');

            if(mq.matches){ // set the pointers position in the mobile version

              if(section==1){
                // avatar.style.setProperty('left','0%');
                start.style.setProperty('left','0%');
                pointer1.style.setProperty('left','100%');
                pointer2.setAttribute('style','display:none');
                pointer3.setAttribute('style','display:none');
              }
            if(section==2){
                // avatar.style.setProperty('left','0%');
                start.setAttribute('style','display:none');
                pointer1.style.setProperty('left','0%');
                pointer2.style.setProperty('left','100%');
                pointer3.setAttribute('style','display:none');
              }
            if(section==3){
                // avatar.style.setProperty('left','0%');
                start.setAttribute('style','display:none');
                pointer1.setAttribute('style','display:none');
                pointer2.style.setProperty('left','0%');
                pointer3.style.setProperty('left','100%');
              }
            }
          });

          // check if question already answered, in which case populate the correct radio input
          const qParams = { c : getCookie('loginToken'), su : 2, s : s, q : q}
          $.post( "https://artathlon.arternative-lab.eu/api/quizVisitorReplied", qParams, function( data )
          {
            data = JSON.parse(data);
            if (data.r && data.r != "")
              $('.form-check-input[value='+data.r+']').attr('checked',true);
          });

          // detect when user selcts an option and send to server
          $(".form-check-input").change(function()
          {
            const params = { c : getCookie('loginToken'), su : 2, s : s, q : q, r : this.value }
            $.post( "https://artathlon.arternative-lab.eu/api/quizVisitorReply", params, function( data )
            {
              data = JSON.parse(data);
              if (!data.code || data.code != "200")
                 console.log("Something went wrong");
            });
          });

      });

      $("#logoutUserBtn").click(function()
      {
          // remove token from server
          $.post( "https://artathlon.arternative-lab.eu/api/logoutQuizVisitor", { c : getCookie('loginToken') }, function()
          {
            // remove token from cookie
            document.cookie = "loginToken=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location = "log-in.html";
          });
      });

   </script>
</body>
</html>
